{% extends "base.html" %}
{% block title %}Ansible Dashboard{% endblock %}
{% block content %}
<!--<script language="javascript">-->
<!--setTimeout(function(){-->
<!--   window.location.reload(1);-->
<!--}, 5000);-->
<!--</script>-->
<script src="{{ url_for('static', filename='js/log_fetch.js') }}"></script>
{% include 'log_modal.html' %}
<script>
function callAndNotifyAndOpenModal(endpoint, runbookid) {
    // Call the endpoint to run the playbook and get the run_id
    callEndpoint(endpoint, (error, response) => {
        if (error) {
            console.error('Error starting the runbook:', error);
            return;
        }

        // Extract the run_id from the server response
        const ansibleRunId = response.run_id;

        // Open the modal
        halfmoon.toggleModal('log-modal');

        // Fetch logs for the specific run_id
        fetchLogs(ansibleRunId);
    });
}
</script>

<table class="table table-hover">
  <thead>
    <tr>
      <th>Playbook Name</th>
      <th>Status</th>
      <th>Started by</th>
      <th>Start</th>
      <th>Duration</th>
      <th>Options</th>
    </tr>
  </thead>
  <tbody>
            {% for row in table_data %}
            <tr>
                <td>{{ row.playbook_name }}</td>
                <td>
                {% if row.status.lower() == "success" %}
                    <span class="badge badge-success"><i class="fa-solid fa-circle-check"></i> Success </span>
                {% elif row.status.lower() == "unknown" %}
                    <span class="badge badge-pill"><i class="fa-solid fa-circle-question"></i> Unknown </span>
                {% elif row.status.lower() == "failed" %}
                    <span class="badge badge-danger"><i class="fa-solid fa-circle-xmark"></i> Failure </span>
                {% elif row.status.lower() == "running" %}
                    <span class="badge badge-primary"><i class="fa-solid fa-forward"></i> Running </span>
                {% endif %}
                </td>
                <td>{{ row.started_by }}</td>
                <td>{{ row.start }}</td>
                <td>{{ row.duration }}</td>
                <td>
<!--                    <button onclick="callAndNotify('/run_playbook/{{ row.id }}')" class="btn btn-primary"> Run now </button>-->
                    <button onclick="callAndNotifyAndOpenModal('/run_playbook/{{ row.id }}', {{ row.id }})" class="btn btn-primary">Run now</button>
                    <a href="/display_logs/{{ row.id }}"><button class="btn btn-primary"> Show recent logs </button></a>
                    <a href="#log-modal" class="btn btn-primary" role="button">Logs</a>
                </td>
            </tr>
            {% endfor %}
<!--<tr><td><span class="badge badge-success"><i class="fa-solid fa-circle-check"></i> Success </span></td><td></td><td></td></tr>-->
<!--<tr><td><span class="badge badge-danger"><i class="fa-solid fa-circle-xmark"></i> Failure </span></td><td></td><td></td></tr>-->
<!--<tr><td><span class="badge badge-primary"><i class="fa-solid fa-forward"></i> Running </span></td><td></td><td></td></tr>-->
<!--<tr><td><span class="badge badge-pill"><i class="fa-solid fa-circle-question"></i> Unknown </span></td><td></td><td></td></tr>-->


  </tbody>
</table>


{% endblock %}